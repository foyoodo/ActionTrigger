name: Release DMG

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-latest
    env:
      APP_NAME: ActionTrigger
      SCHEME: ActionTrigger
      CONFIGURATION: Release
      ARCHIVE_PATH: build/ActionTrigger.xcarchive
      EXPORT_PATH: build/export
      DMG_PATH: build/ActionTrigger.dmg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest"

      - name: Build archive
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            archive

      - name: Export app (unsigned)
        run: |
          set -euo pipefail
          cat > exportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string></string>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist exportOptions.plist

      - name: Create DMG
        run: |
          set -euo pipefail
          APP_PATH="$EXPORT_PATH/$APP_NAME.app"
          hdiutil create \
            -volname "$APP_NAME" \
            -srcfolder "$APP_PATH" \
            -ov -format UDZO \
            "$DMG_PATH"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.DMG_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
